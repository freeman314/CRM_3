# Полная документация CRM-проекта

## 1. Обзор проекта

Данный проект представляет собой систему управления взаимоотношениями с клиентами (CRM) для малого и среднего бизнеса. Система разработана с использованием стека технологий MERN (MongoDB, Express, React, Node.js) и предоставляет функционал для управления клиентской базой, включая отслеживание статусов клиентов, историю взаимодействий и управление задачами.

### 1.1 Основные возможности

- Добавление и управление данными клиентов
- Отслеживание статусов клиентов и дат окончания контрактов
- Управление задачами и напоминаниями
- История звонков и взаимодействий с клиентами
- Система ролей пользователей (менеджер, главный менеджер, администратор)
- Аналитика и отчетность
- Управление справочниками системы

### 1.2 Технологический стек

- Backend: NestJS 11 (REST), Prisma ORM
- База данных: PostgreSQL
- Аутентификация и безопасность: JWT (access/refresh), Passport-JWT, bcrypt, Helmet, Throttler, CORS
- Документация API: Swagger (OpenAPI)
- Frontend: React 19, React Router 7, @tanstack/react-query 5, Vite
- Инфраструктура: Docker Compose (PostgreSQL, pgAdmin), Nginx (опционально для прод)

## 2. Архитектура проекта

Проект следует модульной архитектуре NestJS и разделён на backend и frontend.

### 2.1 Серверная часть (Backend — NestJS)

- Точка входа: `main.ts` — подключение Helmet, CORS, глобальных пайпов валидации (`ValidationPipe`), фильтра исключений (`HttpExceptionFilter`), и Swagger.
- Корневой модуль: `app.module.ts` — подключает `ConfigModule`, `ThrottlerModule`, `PrismaModule` и доменные модули.
- Доменные модули:
  - `auth`: `AuthController`, `AuthService`, `JwtStrategy`, `JwtAuthGuard`, `RolesGuard`, декоратор `@Roles`.
  - `users`: `UsersController` (`GET /users/me`).
  - `clients`: контроллер/сервис/DTO для клиентов.
  - `client-statuses`, `categories`, `cities`, `calls`, `tasks`, `dashboard` — отдельные модули по областям.
  - `prisma`: `PrismaService` для доступа к БД.
  - `common/filters`: `HttpExceptionFilter` для единообразных ответов об ошибках.
- Глобальные Guard'ы: `ThrottlerGuard` (rate limiting). Роли применяются через `RolesGuard` на уровне контроллеров/хэндлеров совместно с `JwtAuthGuard`.

### 2.2 Клиентская часть (Frontend — React)

- Роутинг: `routes.tsx` c защищённой оболочкой `ProtectedLayout`.
- Аутентификация: контекст `AuthProvider` с axios-интерцепторами и хранением токенов в `sessionStorage`.
- Данные/кеш: React Query для серверного состояния.
- Основные страницы: Login, Dashboard, Clients List, Create Client, Client View.

### 2.3 Безопасность и кросс-срезочная логика

- Валидация DTO: `class-validator` + глобальный `ValidationPipe` (whitelist, forbidNonWhitelisted, transform).
- Исключения: `HttpExceptionFilter` (структурированный ответ об ошибках).
- Throttling: `@nestjs/throttler` (по умолчанию 100 запросов/60 сек).
- CORS: источники из переменной `CORS_ORIGIN` (поддержка нескольких через запятую), `credentials: true`.
- Swagger: `GET /api-docs`.

### 2.3 Вспомогательные скрипты

- `initClientStatuses.js`: Скрипт для инициализации базовых статусов клиентов в базе данных

## 3. Модели данных (Prisma)

Ключевые перечисления и модели соответствуют `prisma/schema.prisma`:

```prisma
enum UserRole { manager chief_manager admin }
enum TaskStatus { new in_progress completed }
enum CallResult { successful no_answer rescheduled }

model User {
  id               String   @id @default(cuid())
  username         String   @unique
  email            String   @unique
  passwordHash     String
  role             UserRole @default(manager)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  tasks            Task[]   @relation("TasksAssignedToUser")
  calls            Call[]   @relation("CallsByManager")
  clientsAssigned  Client[] @relation("ClientsAssignedToUser")
  refreshTokenHash String?
  firstLogin       Boolean  @default(true)
}

model ClientStatus {
  id                 String   @id @default(cuid())
  name               String   @unique
  description        String?
  clients            Client[]
  callsWithNewStatus Call[]   @relation("CallNewStatus")
}

model Category {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?
  clients     Client[]
}

model City {
  id      String   @id @default(cuid())
  name    String
  region  String?
  clients Client[]
  @@unique([name, region])
}

model Client {
  id                String        @id @default(cuid())
  firstName         String
  lastName          String
  email             String?       @unique
  phone             String?
  address           String?
  cityId            String?
  city              City?         @relation(fields: [cityId], references: [id])
  currentProvider   String?
  contractEndDate   DateTime?
  notes             String?
  statusId          String?
  status            ClientStatus? @relation(fields: [statusId], references: [id])
  categoryId        String?
  category          Category?     @relation(fields: [categoryId], references: [id])
  potential         String?
  assignedManagerId String?
  assignedManager   User?         @relation("ClientsAssignedToUser", fields: [assignedManagerId], references: [id])
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
  tasks             Task[]
  calls             Call[]
  @@index([lastName, firstName])
  @@index([statusId, contractEndDate])
  @@index([contractEndDate])
}

model Task {
  id           String     @id @default(cuid())
  title        String
  description  String?
  clientId     String
  client       Client     @relation(fields: [clientId], references: [id])
  assignedToId String
  assignedTo   User       @relation(name: "TasksAssignedToUser", fields: [assignedToId], references: [id])
  status       TaskStatus @default(new)
  dueDate      DateTime?
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
}

model Call {
  id           String        @id @default(cuid())
  clientId     String
  client       Client        @relation(fields: [clientId], references: [id])
  managerId    String
  manager      User          @relation(name: "CallsByManager", fields: [managerId], references: [id])
  dateTime     DateTime      @default(now())
  result       CallResult
  comment      String?
  newStatusId  String?
  newStatus    ClientStatus? @relation("CallNewStatus", fields: [newStatusId], references: [id])
  newPotential String?
}
```

## 4. API Endpoints

Префикс сервера по умолчанию: `/` (на dev фронтенд проксирует `/api -> :3000`). Эндпоинты в Swagger (`/api-docs`).

### 4.1 Аутентификация и пользователи
- `POST /auth/login`: вход, ответ `{ access_token, refresh_token, firstLogin }`.
- `POST /auth/refresh`: обновление токенов; тело `{ userId, refreshToken }`. Ротация refresh.
- `POST /auth/logout` (JWT): инвалидация refresh.
- `POST /auth/change-password` (JWT): смена пароля, сброс `firstLogin=false`.
- `GET /users/me` (JWT): текущий пользователь.

### 4.2 Клиенты (JWT, роль: manager/chief_manager/admin)
- `GET /clients`: список с пагинацией и фильтрами `page`, `pageSize`, `q`, `statusId`, `dueInDays`.
- `GET /clients/:id`: карточка клиента.
- `POST /clients` (роль: manager/chief_manager/admin): создать клиента.
- `PATCH /clients/:id` (роль: manager/chief_manager/admin): обновить клиента.
- `DELETE /clients/:id` (роль: admin/chief_manager): удалить клиента.

### 4.3 Справочники (JWT)
- `GET /client-statuses`, `GET /client-statuses/:id`.
- `POST /client-statuses`, `PATCH /client-statuses/:id` (роль: admin/chief_manager).
- `DELETE /client-statuses/:id` (роль: admin).
- `GET /categories`, `GET /categories/:id`.
- `POST /categories`, `PATCH /categories/:id` (роль: chief_manager/admin).
- `DELETE /categories/:id` (роль: admin).
- `GET /cities`, `GET /cities/:id`.
- `POST /cities`, `PATCH /cities/:id` (роль: chief_manager/admin).
- `DELETE /cities/:id` (роль: admin).

### 4.4 Задачи и звонки (JWT)
- Tasks: `GET /tasks`, `GET /tasks/:id`, `POST /tasks`, `PATCH /tasks/:id` (роль: manager/chief_manager/admin), `DELETE /tasks/:id` (роль: chief_manager/admin).
- Calls: `GET /calls/client/:clientId`, `POST /calls` (роль: manager/chief_manager/admin).

### 4.5 Health
- `GET /health`: проверка работоспособности.

## 5. Функциональность клиентской части

### 5.1 Основные функции

- Отображение списка клиентов с возможностью фильтрации и сортировки
- Форма добавления нового клиента
- Форма редактирования информации о клиенте
- Отображение истории взаимодействий с клиентом (звонки, задачи)
- Форма быстрого звонка и обработки информации
- Дашборд с ключевыми показателями и списком ближайших задач
- Календарь с отображением дат окончания контрактов и запланированных задач
- Система уведомлений о приближающихся дедлайнах и важных событиях
- Генерация отчетов

### 5.2 Взаимодействие с сервером

Клиентская часть использует Axios (с интерцепторами для JWT/refresh) и React Query для запросов и кеширования.

## 6. Структура пользовательского интерфейса

### 6.1 Общая структура

- Главное меню (навигационная панель)
- Рабочая область
- Панель уведомлений

### 6.2 Страницы и разделы

1. Страница входа
   - Форма входа
   - Восстановление пароля

2. Дашборд (главная страница после входа)
   - Ключевые показатели
   - Быстрые ссылки на основные разделы
   - Список задач/напоминаний

3. Список клиентов
   - Таблица с клиентами
   - Фильтры и поиск
   - Преднастроенные фильтры по датам окончания контрактов

4. Страница клиента
   - Основная информация
   - История изменений
   - Прикрепленные документы
   - История звонков
   - Список задач, связанных с клиентом

5. Форма добавления/редактирования клиента

6. Календарь
   - Отображение дат окончания контрактов
   - Запланированные задачи

7. Отчеты
   - Выбор типа отчета
   - Настройка параметров
   - Предпросмотр и экспорт

8. Справочники
   - Список справочников
   - Редактирование записей в справочниках

9. Настройки пользователя
   - Изменение пароля
   - Настройка уведомлений

10. Административная панель
    - Управление пользователями
    - Настройки системы
    - Журнал действий пользователей

### 6.3 Дополнительные элементы интерфейса

- Модальные окна для быстрых действий (например, добавление заметки)
- Всплывающие уведомления
- Подсказки и обучающие элементы для новых пользователей

## 7. Прототипы интерфейса

### 7.1 Главная страница (Дашборд)

```
+-----------------------------------------------------+
|  Логотип   Клиенты   Задачи   Отчеты   Профиль     |
+-----------------------------------------------------+
|                                                     |
|  +-------------------+  +------------------------+  |
|  | Статистика         |  | Ближайшие дедлайны     |  |
|  | - Всего клиентов   |  | - Истекает через 2 нед |  |
|  | - Активные         |    (15) [Просмотр >>]     |  |
|  | - Потенциальные    |  | - Истекает через 1 мес |  |
|  +-------------------+    (30) [Просмотр >>]     |  |
|                         +------------------------+  |
|  +-------------------+  +------------------------+  |
|  | Последние действия |  | Быстрые действия       |  |
|  | - Добавлен клиент  |  | [Добавить клиента]     |  |
|  | - Обновлен статус  |  | [Создать задачу]       |  |
|  | - Создана задача   |  | [Сформировать отчет]   |  |
|  +-------------------+  +------------------------+  |
|                                                     |
+-----------------------------------------------------+
```

### 7.2 Список клиентов

```
+-----------------------------------------------------+
|  Логотип   Клиенты   Задачи   Отчеты   Профиль     |
+-----------------------------------------------------+
| Поиск: [                    ]  [Фильтры v]          |
+-----------------------------------------------------+
| Имя    | Телефон   | Статус  | Дедлайн   | Действия |
+-----------------------------------------------------+
| Иван П.| +7 (123)..| Активный| 15.06.2023| [Звонок] |
|        |           |         |           | [Ред.  ] |
+-----------------------------------------------------+
| Анна С.| +7 (456)..| Новый   | 20.06.2023| [Звонок] |
|        |           |         |           | [Ред.  ] |
+-----------------------------------------------------+
| Петр К.| +7 (789)..| Ожидание| 01.07.2023| [Звонок] |
|        |           |         |           | [Ред.  ] |
+-----------------------------------------------------+
|                                                     |
|  [< Пред]  Страница 1 из 10  [След >]               |
+-----------------------------------------------------+
```

### 7.3 Страница клиента

```
+-----------------------------------------------------+
|  Логотип   Клиенты > Иван Петров                    |
+-----------------------------------------------------+
|                                                     |
|  Имя: Иван Петров                                   |
|  Email: ivan@example.com                            |
|  Телефон: +7 (123) 456-78-90                        |
|  Адрес: ул. Примерная, д. 1, кв. 1                  |
|  Статус: Активный                                   |
|  Категория: Частный дом                             |
|                                                     |
|  +-------------------+  +------------------------+  |
|  | История изменений  |  | Документы              |  |
|  | - 01.05: Изменен...| | - Договор.pdf           |  |
|  | - 28.04: Добавлен  | | [Загрузить документ]    |  |
|  +-------------------+  +------------------------+  |
|                                                     |
|  +-------------------+  +------------------------+  |
|  | Заметки            |  | Задачи                 |  |
|  | - Перезвонить в... | | - Отправить КП          |  |
|  | [Добавить заметку] | | [Создать задачу]        |  |
|  +-------------------+  +------------------------+  |
|                                                     |
|  [Редактировать]        [Удалить]                   |
+-----------------------------------------------------+
```

### 7.4 Форма быстрого звонка и обработки информации

```
+-----------------------------------------------------+
|  Логотип   Клиенты > Иван Петров > Новый звонок     |
+-----------------------------------------------------+
|  Имя: Иван Петров                                   |
|  Телефон: +7 (123) 456-78-90                        |
|  Текущий статус: [Текущий статус клиента]           |
|  Дата окончания контракта: 15.06.2023               |
+-----------------------------------------------------+
|  История звонков:                                   |
|  [Таблица с последними 3-5 звонками]                |
+-----------------------------------------------------+
|  Результат текущего звонка:                         |
|  ( ) Успешно связались                              |
|  ( ) Не дозвонились                                 |
|  ( ) Перенесли на другое время                      |
+-----------------------------------------------------+
|  Новый статус: [Выбрать из справочника v]           |
|  Оценка потенциала: [Выбрать из справочника v]      |
|  Комментарий: [                                  ]  |
|                                                     |
|  Следующее действие:                                |
|  [ ] Создать задачу                                 |
|  [ ] Запланировать следующий звонок                 |
|                                                     |
|  [Сохранить и закрыть]  [Отмена]                    |
+-----------------------------------------------------+
```

### 7.5 Страница истории звонков клиента

```
+-----------------------------------------------------+
|  Логотип   Клиенты > Иван Петров > История звонков  |
+-----------------------------------------------------+
|  Имя: Иван Петров                                   |
|  Телефон: +7 (123) 456-78-90                        |
+-----------------------------------------------------+
|  Дата    | Менеджер | Результат | Статус | Действия |
+-----------------------------------------------------+
| 20.05.23 | Анна И.  | Успешно   | Активен| [Подробно]|
| 15.05.23 | Петр С.  | Не дозвон.| Новый  | [Подробно]|
| 10.05.23 | Анна И.  | Перенесен | Новый  | [Подробно]|
+-----------------------------------------------------+
|  [< Пред]  Страница 1 из 3  [След >]                |
|                                                     |
|  [Новый звонок]  [Назад к профилю клиента]          |
+-----------------------------------------------------+
```

## 8. Описание бизнес-процессов

### 8.1 Процесс обработки нового клиента

1. Получение контакта потенциального клиента
2. Создание карточки клиента в CRM
   - Заполнение основной информации
   - Выбор населенного пункта из справочника (или добавление нового)
   - Назначение категории (тип домохозяйства)
   - Установка начального статуса
   - Оценка потенциала клиента
3. Назначение ответственного менеджера
4. Первичный контакт с клиентом
5. Обновление статуса и добавление заметок
6. Отправка коммерческого предложения
7. Последующие переговоры и уточнение деталей
8. Заключение договора или обновление статуса
9. Загрузка подписанных документов
10. Установка даты окончания контракта и планирование следующего контакта

### 8.2 Процесс обработки клиентов с приближающимся дедлайном

1. Система ежедневно проверяет даты окончания контрактов
2. Клиенты группируются по срокам до истечения контракта (2 недели, 1 месяц и т.д.)
3. На дашборде отображаются группы клиентов с количеством
4. Менеджер переходит к списку клиентов конкретной группы
5. Менеджер выбирает клиента для обработки
6. Открывается форма быстрого звонка
7. Менеджер совершает звонок и фиксирует результат
8. В зависимости от результата, менеджер обновляет статус и планирует следующие действия
9. Система обновляет информацию о клиенте и, при необходимости, создает новую задачу

### 8.3 Процесс совершения звонка клиенту

1. Менеджер выбирает клиента для звонка
2. Открывается форма нового звонка с историей предыдущих звонков
3. Менеджер совершает звонок
4. Менеджер фиксирует результат звонка в системе
5. При необходимости обновляется статус и оценка потенциала клиента
6. Менеджер добавляет комментарий и планирует следующие действия
7. Информация о звонке сохраняется в истории звонков клиента
8. Если запланированы дальнейшие действия, создается соответствующая задача

## 9. Требования к развертыванию системы

### 9.1 Требования к развертыванию
- Возможность развертывания на корпоративном сервере
- Доступ для сотрудников с рабочих компьютеров через веб-браузер
- Поддержка одновременной работы множества пользователей

### 9.2 Требования к серверу
- Операционная система: Linux (предпочтительно Ubuntu Server)
- Node.js LTS для сервиса API (NestJS) и Nginx (опционально) для реверс-прокси.
- PostgreSQL 16 (можно через Docker). В репозитории присутствует `docker-compose.yml` для БД и pgAdmin.
- Переменные окружения: `DATABASE_URL`, `JWT_ACCESS_SECRET`, `JWT_REFRESH_SECRET`, `CORS_ORIGIN`, `PORT`.
- Dev: фронтенд (Vite) проксирует `/api` на порт API.

## 10. Управление пользователями системы

### 10.1 Роли пользователей
- Администратор системы
- Главный менеджер
- Менеджер

### 10.2 Функциональность администратора
- Интерфейс управления пользователями:
  - Добавление новых менеджеров
  - Установка начальных паролей
  - Назначение ролей
  - Деактивация учетных записей
  - Сброс паролей
- Просмотр журнала действий пользователей

### 10.3 Безопасность учетных записей
- Обязательная смена пароля при первом входе
- Требования к сложности пароля (минимальная длина, использование букв, цифр и специальных символов)
- Возможность двухфакторной аутентификации (опционально)

### 10.4 Управление сессиями
- Автоматический выход из системы после определенного периода неактивности
- Возможность одновременного входа с нескольких устройств (настраивается администратором)

## 11. Интеграция и расширяемость

### 11.1 API
- Разработка RESTful API для возможности интеграции с другими системами в будущем

### 11.2 Модульная архитектура
- Проектирование системы с учетом возможности добавления новых модулей в будущем

## 12. Тестирование

### 12.1 Виды тестирования
- Модульное (сервисы, утилиты)
- Интеграционное/e2e (NestJS + Supertest + Jest)
- UI-тестирование (по мере усложнения фронтенда)
- Нагрузочное (по необходимости)

### 12.2 Тестовые сценарии
- Аутентификация: login/refresh/logout/change-password, негативные кейсы
- Клиенты: список, фильтры, создание/обновление/удаление с проверкой ролей
- Справочники/задачи/звонки: базовые CRUD и права доступа

## 13. Документация

### 13.1 Пользовательская документация
- Руководство пользователя
- Руководство администратора

### 13.2 Техническая документация
- Документация по API
- Руководство по развертыванию системы

## 14. План разработки

### 14.1 Этапы разработки

1. Проектирование базы данных и API (2 недели)
2. Разработка базового функционала backend (4 недели)
   - Аутентификация и авторизация
   - CRUD операции для клиентов
   - Управление задачами и заметками
3. Разработка пользовательского интерфейса (6 недель)
   - Реализация основных страниц
   - Интеграция с API
4. Реализация дополнительных функций (3 недели)
   - Система уведомлений
   - Отчеты и аналитика
5. Тестирование и отладка (3 недели)
6. Развертывание и настройка сервера (1 неделя)
7. Подготовка документации и обучение пользователей (2 недели)

Общая предварительная оценка времени разработки: 21 неделя

### 14.2 Приоритеты разработки

1. Критически важные функции:
   - Управление клиентами
   - Аутентификация и авторизация
   - Базовый пользовательский интерфейс

2. Важные функции:
   - Управление задачами и заметками
   - Отчеты и аналитика
   - Расширенные функции пользовательского интерфейса

3. Желательные функции:
   - Система уведомлений
   - Расширенная аналитика
   - Интеграция с внешними системами

## 15. Заключение

Данный CRM-проект предоставляет комплексное решение для управления взаимоотношениями с клиентами, ориентированное на потребности малого и среднего бизнеса. Система обеспечивает эффективное управление клиентской базой, отслеживание взаимодействий, управление задачами и аналитику. 

Модульная архитектура и наличие API позволяют расширять функциональность системы в будущем. Особое внимание уделено удобству использования для менеджеров и безопасности данных.

Реализация проекта согласно данной документации позволит создать надежную и эффективную CRM-систему, которая может быть адаптирована под конкретные бизнес-требования и масштабирована по мере роста компании.